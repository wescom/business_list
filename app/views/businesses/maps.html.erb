<div class="page-content">
	<div class="maps_heading">

		<div>  
		  <div id="map3" style='width: 100%; height: 500px;'></div>  
		</div>  
		
		<script type="text/javascript">  
			var business_json = <%=raw @business_locations.to_json %>;
	    var handler;
	    var markers = [];

			handler = Gmaps.build('Google');
			handler.buildMap({ 
				provider: {},
				internal: {
					id: 'map3'
				}
			}, 
			function(){
        markers = handler.addMarkers(business_json);
        _.each(business_json, function(elt, index){
          _.extend(markers[index], elt);
        });
			  handler.bounds.extendWith(markers) 
			  handler.fitMapToBounds()
				handler.getMap().setZoom(<%=params[:zoom]%>)
				handler.map.centerOn(<%= params[:center] %>)
			});
			
			Gmaps.selectMarker = function(id) {
			  $.each(Gmaps.store.markers, function() {
			    if (this.serviceObject.id == id) {
			      this.panTo();
			      this.serviceObject.setAnimation(google.maps.Animation.BOUNCE);
			    }
			    else this.serviceObject.setAnimation(null);
			  });
			};
			
			function refreshMap() {
				console.log("refreshMap");
				handler.setMap(null);
			};
			
			function selectMarker(id){
				console.log(markers);
				let business = markers.find(o => o.id === id);
				if (business != null) {
					console.log(business);
					Gmaps.selectMarker(business);	
				} else {
					console.log('not found');
				};

			};

	    function openMarkerInfo(id) {
				console.log(markers);
				let business = markers.find(o => o.id === id);
				if (business != null) {
					console.log(business);
					google.maps.event.trigger(business.getServiceObject(), 'click')
				} else {
					console.log('not found');
				};
	    };
			
		</script>

	</div>

</div>